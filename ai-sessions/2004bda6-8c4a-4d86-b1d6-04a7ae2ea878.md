---
session_id: 2004bda6-8c4a-4d86-b1d6-04a7ae2ea878
session_name: ""
cwd: /home/alva/repos/tide/move/tide
user_messages_count: 2
assistant_messages_count: 9
---

## 👤 User
*2026-02-09T15:13:11.115Z*

审查下sui move合约部分的代码，路径是 move/tide。产品的设计文档可以参考 readme 和 docs 文件夹

## 🤖 Assistant (claude-opus-4-6)
*2026-02-09T15:13:17.829Z*

我来审查 `move/tide` 下的 Sui Move 合约代码。先并行收集项目文档和代码结构。

## 🤖 Assistant (claude-opus-4-6)
*2026-02-09T15:14:52.788Z*

现在让我深入审查每个源文件的关键逻辑。

## 🤖 Assistant (claude-opus-4-6)
*2026-02-09T15:17:36.889Z*

## Sui Move 合约审查报告

### P0 - 上线前必须修复

**1. `resume_market` 缺少时间校验** (`market.move:214-226`)

`create_market` 要求 `start_time_ms >= clock.timestamp_ms() + interval_ms`，但 `resume_market` 完全不校验 `new_start_time_ms`。管理员可以传入过去的时间甚至 0，导致市场卡死（后续 `settle_and_advance` 无法找到匹配时间戳的价格）。应加入 `Clock` 参数并做同等校验。

**2. `determine_result` 忽略价格指数** (`market.move:420-428`)

开盘/收盘价使用裸 `magnitude` 比较，忽略了 `price_expo`。虽然 Pyth 同一 feed 的指数通常恒定（如 -8），但代码专门存储了 `open_price_expo` / `close_price_expo` 两个字段，说明设计层面考虑过指数可能不同。如果 Pyth 调整精度，当前逻辑会产生错误判定。建议：

- 要么在比较时归一化：`open_p * 10^(close_expo - open_expo)` vs `close_p`
- 要么在 `settle` 时断言 `open_expo == close_expo`（更简单，失败时 revert 而非误判）

---

### P1 - 建议改进

**3. DRAW 时全部资金归国库** (`market.move:366-370`)

`winning_total == 0` 时 `fee = total`，所有投注者血本无归。设计文档确认了这是有意为之，但用户体验很差——平局不是用户的错。多数竞品在 DRAW 时做退款。至少应在前端/文档中显著提示此规则。

**4. `extract_pyth_price` 丢失指数符号** (`market.move:162-166`)

代码取 `magnitude` 后存入 `Option<u64>`，正负指数无法区分。设计文档写的是 `Option<i64>`。实际 Pyth 加密货币 feed 指数恒为负数，但语义上不完整。

---

### P2 - 信息类

- **错误码 103-104 缺失** — 从 102 跳到 105，建议补齐或注释说明。
- **`market_ids` 只增不减** — 设计文档说市场为个位数，可接受。
- **单 AdminCap 无恢复机制** — 丢失后所有管理功能永久失效，标准做法但需运营层面保障。
- **Rounding dust 永久锁定** — 每轮最多 n-1 MIST 留在 pool 中无法提取，规模可忽略。

---

### 设计亮点

- **`settle_and_advance` 原子三步操作**：结算、转换、创建一气呵成，用户始终下注"下一轮"，从根本上消除了价格抢跑风险。
- **模块权限控制**：`public(package)` 严格限制跨模块访问，Round 内部字段只能通过 market 模块操作。
- **Ticket 灵魂绑定**：`key` without `store`，正确阻止转让。
- **u128 中间量防溢出**：fee 和 payout 计算均经 `u128` 过渡。
- **测试覆盖全面**：涵盖正常流程、DRAW、单边、无注、暂停/恢复、时间戳越界等场景，共 20+ test case。

---

需要我针对 P0 问题出具修复方案吗？

## 👤 User
*2026-02-09T15:31:36.646Z*

第三点，是规则就这么设计，无需调整。第四点应该是需要修改文档，同步为 u64 而非 i64，我们拿到 price 和 expo 就行了。其他的按照你的思路调整

## 🤖 Assistant (claude-opus-4-6)
*2026-02-09T15:32:26.531Z*

明白。总结要做的改动：

1. **P0**: `resume_market` 加 `Clock` 校验
2. **P0**: 结算时断言 `open_expo == close_expo`
3. **文档**: `Option<i64>` → `Option<u64>`

## 🤖 Assistant (claude-opus-4-6)
*2026-02-09T15:32:47.135Z*

现在在结算逻辑中加入指数一致性断言。

## 🤖 Assistant (claude-opus-4-6)
*2026-02-09T15:32:59.387Z*

现在更新测试文件，所有 `resume_market` 调用需要加 `clock` 参数。

## 🤖 Assistant (claude-opus-4-6)
*2026-02-09T15:33:34.828Z*

现在更新文档，`i64` → `u64`。

## 🤖 Assistant (claude-opus-4-6)
*2026-02-09T15:33:45.706Z*

现在跑一下测试验证改动正确性。

## 🤖 Assistant (claude-opus-4-6)
*2026-02-09T15:34:00.418Z*

全部 34 个测试通过。改动总结：

**`market.move`**
- `resume_market` 新增 `clock: &Clock` 参数，校验 `new_start_time_ms >= clock.timestamp_ms() + interval_ms`，与 `create_market` 保持一致（`:218`）
- 新增 `EExponentMismatch = 114` 错误码（`:34`）
- 结算时断言 `open_expo == close_expo`，指数不一致直接 revert 而非误判（`:351`）

**`tide_tests.move`**
- 三处 `resume_market` 调用同步加入 `clock` 参数

**`docs/contract.md`**
- `open_price_expo` / `close_price_expo` 类型从 `Option<i64>` 更正为 `Option<u64>`
